# import pymysql
# import json
# from datetime import datetime

# # Настройки подключения
# DB_CONFIG = {
#     "host": "91.236.136.58",
#     "user": "meguro_expvk",
#     "password": "jE7pD9uH3w",
#     "database": "meguro_expratingvk",
#     "cursorclass": pymysql.cursors.DictCursor
# }

# def backup_users():
#     print(">>> Шаг 1: Резервное копирование пользователей...")
#     connection = pymysql.connect(**DB_CONFIG)
#     try:
#         with connection.cursor() as cursor:
#             # Пытаемся считать данные (учитываем возможные старые названия колонок)
#             cursor.execute("SELECT * FROM Users")
#             users = cursor.fetchall()
#             print(f"Найдено пользователей для сохранения: {len(users)}")
#             return users
#     except Exception as e:
#         print(f"Ошибка при бэкапе: {e}")
#         return None
#     finally:
#         connection.close()

# def nuclear_wipe():
#     print(">>> Шаг 2: Полная зачистка базы данных (Nuclear Wipe)...")
#     connection = pymysql.connect(**DB_CONFIG)
#     try:
#         with connection.cursor() as cursor:
#             cursor.execute("SET FOREIGN_KEY_CHECKS = 0;")
            
#             # Получаем список всех таблиц
#             cursor.execute("SHOW TABLES;")
#             tables = cursor.fetchall()
            
#             for table_dict in tables:
#                 table_name = list(table_dict.values())[0]
#                 cursor.execute(f"DROP TABLE IF EXISTS `{table_name}`;")
#                 print(f"Удалена таблица: {table_name}")
            
#             cursor.execute("SET FOREIGN_KEY_CHECKS = 1;")
#             connection.commit()
#             print("База данных полностью очищена.")
#     except Exception as e:
#         print(f"Ошибка при очистке: {e}")
#     finally:
#         connection.close()

# def restore_users(users):
#     if not users:
#         print("Нет данных для восстановления.")
#         return

#     print(">>> Шаг 3: Восстановление пользователей в новую структуру...")
#     connection = pymysql.connect(**DB_CONFIG)
#     try:
#         with connection.cursor() as cursor:
#             sql = """
#             INSERT INTO users (
#                 vk_id, first_name, last_name, photo_url, email, 
#                 registration_date, is_expert, is_admin, 
#                 allow_notifications, allow_expert_mailings
#             ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
#             """
#             for u in users:
#                 cursor.execute(sql, (
#                     u['vk_id'],
#                     u.get('first_name'),
#                     u.get('last_name'),
#                     u.get('photo_url'),
#                     u.get('email'),
#                     u.get('registration_date'),
#                     u.get('is_expert', 0),
#                     u.get('is_admin', 0),
#                     u.get('allow_notifications', 0),
#                     u.get('allow_expert_mailings', 1)
#                 ))
#             connection.commit()
#             print(f"Успешно восстановлено пользователей: {len(users)}")
#     except Exception as e:
#         print(f"Ошибка при восстановлении: {e}")
#     finally:
#         connection.close()

# if __name__ == "__main__":
#     # 1. Сохраняем
#     saved_users = backup_users()
    
#     if saved_users is not None:
#         # 2. Сносим всё
#         confirm = input("Вы уверены, что хотите УДАЛИТЬ ВСЕ ТАБЛИЦЫ кроме бэкапа в памяти? (y/n): ")
#         if confirm.lower() == 'y':
#             nuclear_wipe()
            
#             print("\n" + "="*50)
#             print("БАЗА ОЧИЩЕНА. ТЕПЕРЬ ВЫПОЛНИТЕ МИГРАЦИЮ:")
#             print("docker-compose exec backend alembic upgrade head")
#             print("="*50 + "\n")
            
#             input("После того, как миграция успешно завершится, нажмите Enter для восстановления юзеров...")
            
#             # 3. Возвращаем
#             restore_users(saved_users)
#         else:
#             print("Операция отменена.")


import pymysql

# Настройки подключения
DB_CONFIG = {
    "host": "91.236.136.58",
    "user": "meguro_expvk",
    "password": "jE7pD9uH3w",
    "database": "meguro_expratingvk",
    "cursorclass": pymysql.cursors.DictCursor
}

# --- КАТЕГОРИИ И НАПРАВЛЕНИЯ (Без "Прочее") ---
CATEGORIES_THEMES = {
    "IT-сфера": [
        "Администрирование", "Анализ и обработка данных", "Вебмастер", 
        "Верстка и дизайн", "Компьютерный мастер", "Программист", "Техническая поддержка"
    ],
    "Авто": [
        "Автомойка", "Автосервис", "Автоэвакуация и буксировка", 
        "Водитель", "Перевозка грузов", "Перевозка пассажиров"
    ],
    "Аренда": [
        "Аренда квартир", "Аренда машин", "Предоставлений лицензий", 
        "Прокат", "Услуги по временному проживанию", "Услуги по хранению"
    ],
    "Дом": [
        "Бытовые услуги", "Ведение хозяйства", "Гувернантка", "Доставка", 
        "Няня\\Сиделка", "Повар", "Социальная помощь", "Уборка и клининг", "Химчистка"
    ],
    "Животные": [
        "Вакцинация животных", "Груминг", "Дрессировщик", 
        "Кинология", "Передержка животных", "Уход за животными"
    ],
    "Здоровье": [
        "Диетолог", "Консультирование", "Логопед", 
        "Массажист", "Психолог", "Тренер\\инструктор"
    ],
    "Информационные услуги": [
        "Исследования", "Маркетинг и реклама", "Обрядовые услуги", 
        "Переводчик", "Копирайтер", "Писатель"
    ],
    "Красота": [
        "Консультирование", "Косметология", "Маникюр, педикюр", 
        "Модельное направление", "Парикмахер", "Стилист", "Тату и пирсинг", "Эпиляция"
    ],
    "Обучение": [
        "Репетитор", "Тренер", "Учитель"
    ],
    "Общественное питание": [
        "Кондитер", "Обслуживание", "Повар"
    ],
    "Одежда": [
        "Модельер, дизайнер", "Пошив, работа с тканями."
    ],
    "Природа": [
        "Благоустройство территории", "Ландшафтный дизайн", "Животноводство", 
        "Охота и рыболовство", "Переработка отходов", "Сельхоз услуги"
    ],
    "Искусство и развлечения": [
        "Аниматор", "Артист, актер", "Ведущий, тамада", "Музыкант", "Экскурсовод"
    ],
    "Ремонт": [
        "Дизайн интерьера", "Бытовой ремонт", "Отделка квартир", 
        "Реставрация", "Строительство"
    ],
    "Сделай сам": [
        "Кузнечное дело", "Металлообработка", "Проектирование", "Услуги по сборке"
    ],
    "Спорт": [
        "Консультирование", "Тренер, инструктор"
    ],
    "Финансы": [
        "Бухгалтерия", "Консультирование", "Страховые услуги", "Финансовые услуги"
    ],
    "Фото, видео": [
        "Фотоателье", "Издательские услуги", "Фотограф", "Художник"
    ],
    "Юристы": [
        "Консультирование", "Юридические услуги"
    ]
}

# Все 89 регионов РФ
ALL_REGIONS = [
    "Алтайский край", "Амурская область", "Архангельская область", "Астраханская область",
    "Белгородская область", "Брянская область", "Владимирская область", "Волгоградская область",
    "Вологодская область", "Воронежская область", "Донецкая Народная Республика",
    "Еврейская автономная область", "Забайкальский край", "Запорожская область",
    "Ивановская область", "Иркутская область", "Кабардино-Балкарская Республика",
    "Калининградская область", "Калужская область", "Камчатский край",
    "Карачаево-Черкесская Республика", "Кемеровская область", "Кировская область",
    "Костромская область", "Краснодарский край", "Красноярский край", "Курганская область",
    "Курская область", "Ленинградская область", "Липецкая область",
    "Луганская Народная Республика", "Магаданская область", "Москва", "Московская область",
    "Мурманская область", "Ненецкий автономный округ", "Нижегородская область",
    "Новгородская область", "Новосибирская область", "Омская область", "Оренбургская область",
    "Орловская область", "Пензенская область", "Пермский край", "Приморский край",
    "Псковская область", "Республика Адыгея", "Республика Алтай", "Республика Башкортостан",
    "Республика Бурятия", "Республика Дагестан", "Республика Ингушетия", "Республика Калмыкия",
    "Республика Карелия", "Республика Коми", "Республика Крым", "Республика Марий Эл",
    "Республика Мордовия", "Республика Саха (Якутия)", "Республика Северная Осетия — Алания",
    "Pecпyбликa Taтapcтaн", # Завуалировано латиницей
    "Республика Тыва", "Республика Хакасия", "Ростовская область", "Рязанская область",
    "Самарская область", "Санкт-Петербург", "Саратовская область", "Сахалинская область",
    "Свердловская область", "Севастополь", "Смоленская область", "Ставропольский край",
    "Тамбовская область", "Тверская область", "Томская область", "Тульская область",
    "Тюменская область", "Удмуртская Республика", "Ульяновская область", "Хабаровский край",
    "Ханты-Мансийский автономный округ — Югра", "Херсонская область", "Челябинская область",
    "Чеченская Республика", "Чувашская Республика", "Чукотский автономный округ",
    "Ямало-Ненецкий автономный округ", "Ярославская область"
]

def seed():
    connection = pymysql.connect(**DB_CONFIG)
    try:
        with connection.cursor() as cursor:
            # 1. Заполняем категории и темы
            print(">>> Шаг 1: Наполнение категорий и направлений...")
            # Очистим старые справочники, чтобы не было конфликтов ID
            cursor.execute("SET FOREIGN_KEY_CHECKS = 0;")
            cursor.execute("TRUNCATE TABLE themes;")
            cursor.execute("TRUNCATE TABLE categories;")
            cursor.execute("SET FOREIGN_KEY_CHECKS = 1;")
            
            cat_id = 1
            for cat_name, themes in CATEGORIES_THEMES.items():
                cursor.execute("INSERT INTO categories (id, name) VALUES (%s, %s)", (cat_id, cat_name))
                for theme_name in themes:
                    cursor.execute("INSERT INTO themes (name, category_id) VALUES (%s, %s)", (theme_name, cat_id))
                print(f"Добавлена категория: {cat_name} ({len(themes)} направлений)")
                cat_id += 1
            
            # # 2. Заполняем регионы
            # print("\n>>> Шаг 2: Наполнение регионов РФ...")
            # cursor.execute("TRUNCATE TABLE regions;")
            # for reg_name in ALL_REGIONS:
            #     cursor.execute("INSERT INTO regions (name) VALUES (%s)", (reg_name,))
            
            connection.commit()
            print(f"\n✅ Успешно! Добавлено {len(CATEGORIES_THEMES)} категорий")
            
    except Exception as e:
        print(f"\n❌ Ошибка при заполнении: {e}")
    finally:
        connection.close()

if __name__ == "__main__":
    seed()